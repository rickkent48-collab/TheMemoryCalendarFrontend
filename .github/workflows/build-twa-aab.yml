name: Build Signed TWA App Bundle

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Android SDK
        run: |
          set -euo pipefail
          
          echo "::group::Setting up Android SDK"
          
          # Set ANDROID_SDK_ROOT
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # Create SDK directory
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT
          
          # Download and install commandline-tools
          echo "Downloading Android commandline-tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
          
          echo "Extracting commandline-tools..."
          unzip -q /tmp/cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          
          # Move to proper structure (cmdline-tools/latest)
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv /tmp/cmdline-tools-tmp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          
          echo "::endgroup::"
          
          echo "::group::Accepting Android SDK licenses"
          # Accept licenses - use yes with proper error handling
          yes 2>/dev/null | sdkmanager --licenses || echo "License acceptance process completed (exit code: $?)"
          echo "::endgroup::"
          
          echo "::group::Installing Android SDK components"
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --install "platform-tools" "platforms;android-35" "build-tools;35.0.0"
          echo "::endgroup::"
          
          echo "::group::Verifying Android SDK installation"
          echo "âœ“ Android SDK setup complete"
          
          # Echo versions for diagnostics
          echo "SDK Manager version:"
          sdkmanager --version || echo "Note: sdkmanager version check failed, but this does not affect SDK functionality"
          
          # Verify installation
          echo ""
          echo "SDK components installed:"
          sdkmanager --list_installed
          echo "::endgroup::"
      
      - name: Restore upload keystore from secrets
        env:
          UPLOAD_KEYSTORE_BASE64: ${{ secrets.UPLOAD_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${UPLOAD_KEYSTORE_BASE64:-}" ]; then
            echo "::error::UPLOAD_KEYSTORE_BASE64 secret is missing"
            exit 1
          fi
          echo "$UPLOAD_KEYSTORE_BASE64" | base64 -d > upload-keystore.jks
      
      - name: Show keystore fingerprints (diagnostics)
        env:
          UPLOAD_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          UPLOAD_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
        run: |
          set -euo pipefail
          echo "::group::Keystore fingerprints"
          
          # Get keystore info once and reuse
          # Note: Password is passed via environment variable, not command line args
          KEYSTORE_INFO=$(keytool -list -v -keystore upload-keystore.jks -alias "$UPLOAD_KEY_ALIAS" -storepass "$UPLOAD_KEYSTORE_PASSWORD" 2>/dev/null || true)
          
          # Display first 120 lines for diagnostics
          echo "$KEYSTORE_INFO" | sed -n '1,120p'
          
          # Extract fingerprints with validation
          SHA1=$(echo "$KEYSTORE_INFO" | grep "SHA1:" | sed 's/.*SHA1: //' | tr -d '[:space:]')
          SHA256=$(echo "$KEYSTORE_INFO" | grep "SHA256:" | sed 's/.*SHA256: //' | tr -d '[:space:]')
          
          # Validate fingerprints were extracted
          if [ -z "$SHA1" ] || [ -z "$SHA256" ]; then
            echo "::error::Failed to extract keystore fingerprints"
            echo "SHA1: ${SHA1:-empty}"
            echo "SHA256: ${SHA256:-empty}"
            exit 1
          fi
          
          echo ""
          echo "UPLOAD KEY SHA1:   $SHA1"
          echo "UPLOAD KEY SHA256: $SHA256"
          echo "KEYSTORE_SHA1=$SHA1" >> $GITHUB_ENV
          echo "KEYSTORE_SHA256=$SHA256" >> $GITHUB_ENV
          echo "::endgroup::"
          
          # Create credentials file for reference
          cat > keystore-credentials.txt << EOF
          Keystore: upload-keystore.jks (permanent)
          Store Type: JKS
          Key Alias: $UPLOAD_KEY_ALIAS
          SHA1:   $SHA1
          SHA256: $SHA256
          
          Note: This is a permanent keystore managed via GitHub Secrets.
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
      
      - name: Build signed release app bundle (Gradle signing)
        working-directory: android-project
        env:
          SIGN_STORE_FILE: ${{ github.workspace }}/upload-keystore.jks
          SIGN_STORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          SIGN_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
          SIGN_KEY_PASSWORD: ${{ secrets.UPLOAD_KEY_PASSWORD }}
          VERSION_CODE: ${{ 100000 + github.run_number }}
          VERSION_NAME: 1.0.${{ github.run_number }}
        run: |
          set -euo pipefail
          
          echo "::group::Building signed release app bundle"
          
          # Verify gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found in android-project/"
            echo "Contents of android-project:"
            ls -la
            exit 1
          fi
          
          # Build the release app bundle using Gradle with signing
          chmod +x gradlew
          ./gradlew --stacktrace --no-daemon bundleRelease
          
          echo "âœ“ Signed app bundle built successfully"
          echo "::endgroup::"
      
      - name: Copy signed AAB to repository root
        run: |
          set -euo pipefail
          
          AAB_PATH=$(find android-project/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "::error::Could not find AAB file in app/build/outputs/bundle/release"
            exit 1
          fi
          
          echo "Found signed AAB: $AAB_PATH"
          cp "$AAB_PATH" TheMemoryCalendar-release-signed.aab
          echo "Copied to: TheMemoryCalendar-release-signed.aab"
          ls -lh TheMemoryCalendar-release-signed.aab
      
      - name: Generate job summary
        run: |
          set -euo pipefail
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… TWA Signed App Bundle Build Complete
          
          ## ðŸ” Upload Key Fingerprints
          - **SHA1:** \`$KEYSTORE_SHA1\`
          - **SHA-256:** \`$KEYSTORE_SHA256\`
          
          ## ðŸ“¦ Artifacts
          The signed Android App Bundle and keystore have been uploaded:
          - **TheMemoryCalendar-release-signed.aab** - Signed bundle ready for Play Console
          - **upload-keystore.jks** - JKS keystore used for signing
          - **keystore-credentials.txt** - Keystore alias information
          
          ## ðŸš€ Next Steps: Play Console Upload
          
          ### 1. Upload to Google Play Console
          - Download the artifact \`app-bundle-signed\` from this workflow run
          - Go to [Google Play Console](https://play.google.com/console)
          - Navigate to your app â†’ **Internal testing** track
          - Create a new release and upload \`TheMemoryCalendar-release-signed.aab\`
          
          ### 2. Verify Upload Key
          - The uploaded AAB is signed with the **upload key** (fingerprints shown above)
          - Google Play Console will verify this matches the expected upload key
          - If this is your first upload, Play Console will register this upload key
          
          ### 3. Enable Play App Signing (if not already enabled)
          - During the first upload, Google will prompt you to enable **Play App Signing**
          - Accept and let Google manage your app signing key
          - Google will re-sign your AAB with their managed key for distribution
          
          ### 4. Update assetlinks.json with App Signing Key
          After enabling Play App Signing:
          1. Go to **Play Console â†’ Setup â†’ App signing**
          2. Copy the **App signing key certificate SHA-256 fingerprint** (different from upload key)
          3. Update the \`assetlinks.json\` file at:
             \`\`\`
             https://rickkent48-collab.github.io/.well-known/assetlinks.json
             \`\`\`
          4. Replace the SHA-256 fingerprint in the \`sha256_cert_fingerprints\` array with the **App signing key** from Play Console
          
          ### 5. Verify TWA Integration
          - Install the app from Internal Testing on your device
          - The app should open fullscreen without the browser URL bar
          - If you see a URL bar, verify the assetlinks.json SHA-256 matches the **App signing key** exactly
          
          ## ðŸ“š Additional Resources
          - [Play App Signing Documentation](https://support.google.com/googleplay/android-developer/answer/9842756)
          - [Trusted Web Activity Overview](https://developer.chrome.com/docs/android/trusted-web-activity/)
          
          ---
          
          **Build Info:**
          - Workflow: \`${{ github.workflow }}\`
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Run ID: \`${{ github.run_id }}\`
          - Signing: Gradle signingConfigs (permanent JKS upload keystore)
          - Target SDK: 35
          EOF
      
      - name: Upload signed AAB and keystore
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle-signed
          path: |
            TheMemoryCalendar-release-signed.aab
            upload-keystore.jks
            keystore-credentials.txt
          retention-days: 90
