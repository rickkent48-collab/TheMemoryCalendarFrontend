name: Build Signed TWA App Bundle

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install expect for non-interactive bubblewrap init
        run: sudo apt-get update && sudo apt-get install -y expect tree
      
      - name: Install Bubblewrap CLI
        run: |
          set -euo pipefail
          
          npm install -g @bubblewrap/cli
          
          # Echo versions for diagnostics
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Bubblewrap version: $(bubblewrap --version || echo 'version command not available')"
      
      - name: Set up Android SDK
        run: |
          set -euo pipefail
          
          echo "::group::Setting up Android SDK"
          
          # Set ANDROID_SDK_ROOT
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # Create SDK directory
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT
          
          # Download and install commandline-tools
          echo "Downloading Android commandline-tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
          
          echo "Extracting commandline-tools..."
          unzip -q /tmp/cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          
          # Move to proper structure (cmdline-tools/latest)
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv /tmp/cmdline-tools-tmp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          
          echo "::endgroup::"
          
          echo "::group::Accepting Android SDK licenses"
          # Accept licenses - use yes with proper error handling
          yes 2>/dev/null | sdkmanager --licenses || echo "License acceptance process completed (exit code: $?)"
          echo "::endgroup::"
          
          echo "::group::Installing Android SDK components"
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          echo "::endgroup::"
          
          echo "::group::Verifying Android SDK installation"
          echo "âœ“ Android SDK setup complete"
          
          # Echo versions for diagnostics
          echo "SDK Manager version:"
          sdkmanager --version || echo "Note: sdkmanager version check failed, but this does not affect SDK functionality"
          
          # Verify installation
          echo ""
          echo "SDK components installed:"
          sdkmanager --list_installed
          echo "::endgroup::"
      
      - name: Initialize TWA project with bubblewrap
        run: |
          set -euo pipefail
          
          echo "::group::Environment diagnostics"
          # Print diagnostics
          echo "Environment diagnostics:"
          echo "JAVA_HOME: $JAVA_HOME"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Bubblewrap version: $(bubblewrap --version || echo 'version command not available')"
          echo "::endgroup::"
          
          echo "::group::Verifying JAVA_HOME"
          # Verify JAVA_HOME is set and the path exists
          if [ -z "$JAVA_HOME" ]; then
            echo "ERROR: JAVA_HOME is not set"
            exit 1
          fi
          
          if [ ! -d "$JAVA_HOME" ]; then
            echo "ERROR: JAVA_HOME path does not exist: $JAVA_HOME"
            exit 1
          fi
          
          echo "âœ“ JAVA_HOME is set to: $JAVA_HOME"
          echo "âœ“ JAVA_HOME path exists"
          echo "Contents of JAVA_HOME:"
          ls -la "$JAVA_HOME" | head -20
          echo "::endgroup::"
          
          echo "::group::Creating expect script"
          # Create comprehensive expect script for non-interactive bubblewrap init
          cat > /tmp/bubblewrap-init.exp << 'EOF'
          #!/usr/bin/expect -f
          set timeout 600
          
          # Initialize JDK prompt counter for fail-fast behavior
          set jdk_prompt_count 0
          
          puts "========================================="
          puts "Bubblewrap Init - Expect Script Starting"
          puts "========================================="
          puts "Bubblewrap will install its own JDK during initialization"
          puts ""
          
          spawn bubblewrap init --manifest https://rickkent48-collab.github.io/TheMemoryCalendarFrontend/manifest.webmanifest
          
          expect {
            -re "Do you want Bubblewrap to install the JDK.*\\?" {
              puts "\n>>> Prompt detected: 'Do you want Bubblewrap to install the JDK?'"
              puts ">>> Responding: Y (let Bubblewrap install JDK)"
              send "Y\r"
              exp_continue
            }
            -re "Path to your existing JDK.*:" {
              incr jdk_prompt_count
              puts "\n>>> ERROR: Unexpected prompt detected: 'Path to your existing JDK' (attempt #$jdk_prompt_count)"
              puts "This prompt should not appear when we answered Y to install JDK."
              puts "Aborting to prevent infinite loop."
              exit 1
            }
            -re "Directory where to generate the project" {
              puts "\n>>> Prompt detected: 'Directory where to generate the project'"
              puts ">>> Responding: android-project"
              send "android-project\r"
              exp_continue
            }
            -re "Name for the application" {
              puts "\n>>> Prompt detected: 'Name for the application'"
              puts ">>> Responding: The Memory Calendar"
              send "The Memory Calendar\r"
              exp_continue
            }
            -re "Name for the package" {
              puts "\n>>> Prompt detected: 'Name for the package'"
              puts ">>> Responding: com.github.thememorycalendar"
              send "com.github.thememorycalendar\r"
              exp_continue
            }
            -re "Minimum version" {
              puts "\n>>> Prompt detected: 'Minimum version'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Target.*version" {
              puts "\n>>> Prompt detected: 'Target version'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Status bar color" {
              puts "\n>>> Prompt detected: 'Status bar color'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Splash screen.*color" {
              puts "\n>>> Prompt detected: 'Splash screen color'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Display mode" {
              puts "\n>>> Prompt detected: 'Display mode'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Orientation" {
              puts "\n>>> Prompt detected: 'Orientation'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Theme color" {
              puts "\n>>> Prompt detected: 'Theme color'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Background color" {
              puts "\n>>> Prompt detected: 'Background color'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Enable site.*settings shortcut" {
              puts "\n>>> Prompt detected: 'Enable site settings shortcut'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Shortcuts" {
              puts "\n>>> Prompt detected: 'Shortcuts'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "Include app.*fallback" {
              puts "\n>>> Prompt detected: 'Include app fallback'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "signing key" {
              puts "\n>>> Prompt detected: 'signing key'"
              puts ">>> Responding: <enter> (accept default)"
              send "\r"
              exp_continue
            }
            -re "launch Android Studio" {
              puts "\n>>> Prompt detected: 'launch Android Studio'"
              puts ">>> Responding: N (skip Android Studio)"
              send "N\r"
              exp_continue
            }
            -re "already exists" {
              puts "\n>>> Prompt detected: 'already exists'"
              puts ">>> Responding: y (overwrite existing project)"
              send "y\r"
              exp_continue
            }
            timeout {
              puts "\n========================================="
              puts "ERROR: Bubblewrap init timed out"
              puts "========================================="
              puts "Waited 600 seconds for prompt but none arrived"
              puts "This likely indicates a hang in the bubblewrap init process"
              puts ""
              puts "Possible causes:"
              puts "1. Manifest URL is not accessible"
              puts "2. Android SDK is not properly configured"
              puts "3. Unexpected prompt from bubblewrap"
              puts "4. JDK installation by Bubblewrap failed"
              puts ""
              exit 1
            }
            eof {
              puts "\n========================================="
              puts "Bubblewrap Init - Process Completed"
              puts "========================================="
              puts "Bubblewrap installed its own JDK and initialized the project successfully"
              puts ""
            }
          }
          
          # Wait for spawned process to complete and collect exit status (TCL/expect command)
          wait
          EOF
          
          chmod +x /tmp/bubblewrap-init.exp
          echo "Expect script created"
          echo "::endgroup::"
          
          echo "::group::Running bubblewrap init"
          echo "Running bubblewrap init..."
          /tmp/bubblewrap-init.exp
          echo "Bubblewrap init completed"
          echo "::endgroup::"
          
          echo "::group::Verifying android-project creation"
          # Verify android-project was created
          echo "Verifying android-project creation..."
          if [ ! -d "android-project" ]; then
            echo "========================================="
            echo "ERROR: android-project directory not created"
            echo "========================================="
            echo "The android-project directory was not created by bubblewrap init."
            echo "This indicates bubblewrap init failed or was aborted."
            echo ""
            echo "Possible causes:"
            echo "1. Bubblewrap failed to install JDK"
            echo "2. Manifest URL was not accessible"
            echo "3. Android SDK configuration issue"
            echo "4. Expect script failed to handle a prompt"
            echo ""
            echo "Check the expect script output above for details."
            echo ""
            
            # Show twa-manifest.json if it exists for debugging
            if [ -f "twa-manifest.json" ]; then
              echo "Contents of twa-manifest.json:"
              cat twa-manifest.json
              echo ""
            fi
            
            echo "Current directory contents:"
            ls -la
            echo ""
            
            exit 1
          fi
          
          echo "âœ“ android-project directory created"
          
          # Verify gradlew was created
          if [ ! -f "android-project/gradlew" ]; then
            echo "========================================="
            echo "ERROR: android-project/gradlew not found"
            echo "========================================="
            echo "The android-project directory exists but gradlew was not created."
            echo "This indicates bubblewrap init may have partially completed."
            echo ""
            echo "Contents of android-project:"
            ls -la android-project/ || echo "Cannot list android-project"
            echo ""
            echo "This usually means:"
            echo "1. Bubblewrap init was interrupted"
            echo "2. Project generation failed partway through"
            echo "3. Gradle wrapper was not properly created"
            echo ""
            exit 1
          fi
          
          echo "âœ“ android-project/gradlew found"
          
          # Show tree structure for debugging
          echo ""
          echo "Android project tree structure:"
          tree -L 3 android-project || find android-project -maxdepth 3 -print | sort
          
          # Show twa-manifest.json if it exists
          if [ -f "twa-manifest.json" ]; then
            echo ""
            echo "Contents of twa-manifest.json:"
            cat twa-manifest.json
          fi
          
          echo ""
          echo "âœ“ All verifications passed - android-project is ready"
          echo "::endgroup::"
      
      - name: Replace adaptive launcher icons
        run: |
          set -euo pipefail
          
          # Verify android-project exists before modifying
          if [ ! -d "android-project" ]; then
            echo "ERROR: android-project directory does not exist. Cannot replace icons."
            exit 1
          fi
          
          # Copy adaptive icons from repo to Android project
          mkdir -p android-project/app/src/main/res/drawable
          
          cp icons/adaptive-foreground-432.png android-project/app/src/main/res/drawable/ic_launcher_foreground.png
          cp icons/adaptive-background-432.png android-project/app/src/main/res/drawable/ic_launcher_background.png
          
          # Ensure ic_launcher.xml and ic_launcher_round.xml reference the correct drawables
          # Check if mipmap-anydpi-v26 exists, if not create it
          mkdir -p android-project/app/src/main/res/mipmap-anydpi-v26
          
          # Create or update ic_launcher.xml
          cat > android-project/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml << 'XMLEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          XMLEOF
          
          # Create or update ic_launcher_round.xml
          cat > android-project/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml << 'XMLEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          XMLEOF
          
          echo "âœ“ Adaptive icons replaced successfully"
      
      - name: Generate keystore passwords
        id: keystore-passwords
        run: |
          set -euo pipefail
          
          # Generate random passwords for keystore
          KEYSTORE_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          KEY_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          
          echo "keystore_password=$KEYSTORE_PASSWORD" >> $GITHUB_OUTPUT
          echo "key_password=$KEY_PASSWORD" >> $GITHUB_OUTPUT
          
          echo "Generated keystore passwords"
      
      - name: Generate upload keystore
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
        run: |
          set -euo pipefail
          
          # Generate a new keystore for signing the app
          keytool -genkeypair -v \
            -keystore upload-keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias upload \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -dname "CN=The Memory Calendar, OU=Development, O=GitHub, L=Unknown, ST=Unknown, C=US"
          
          echo "Upload keystore generated successfully"
      
      - name: Build release app bundle
        working-directory: android-project
        run: |
          set -euo pipefail
          
          echo "::group::Building release app bundle"
          
          # Verify gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found in android-project/"
            echo "Contents of android-project:"
            ls -la
            exit 1
          fi
          
          # Build the release app bundle using Gradle
          chmod +x gradlew
          ./gradlew bundleRelease --stacktrace
          
          echo "âœ“ App bundle built successfully"
          echo "::endgroup::"
      
      - name: Sign the app bundle
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
        run: |
          set -euo pipefail
          
          # Find the unsigned AAB
          AAB_PATH=$(find android-project/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          
          if [ -z "$AAB_PATH" ]; then
            echo "Error: Could not find AAB file"
            exit 1
          fi
          
          echo "Found AAB at: $AAB_PATH"
          
          # Sign the AAB with jarsigner
          jarsigner -verbose \
            -keystore upload-keystore.jks \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            "$AAB_PATH" \
            upload
          
          # Copy the signed AAB to a well-known location
          cp "$AAB_PATH" TheMemoryCalendar-release-signed.aab
          
          echo "App bundle signed successfully"
      
      - name: Get upload key SHA-256 fingerprint
        id: fingerprint
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
        run: |
          set -euo pipefail
          
          # Get the SHA-256 fingerprint of the upload key
          FINGERPRINT=$(keytool -list -v \
            -keystore upload-keystore.jks \
            -alias upload \
            -storepass "$KEYSTORE_PASSWORD" | \
            grep "SHA256:" | \
            sed 's/.*SHA256: //')
          
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT
          echo "Upload Key SHA-256 Fingerprint: $FINGERPRINT"
      
      - name: Create credentials file
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
          FINGERPRINT: ${{ steps.fingerprint.outputs.fingerprint }}
        run: |
          set -euo pipefail
          
          cat > keystore-credentials.txt << EOF
          Upload Keystore Credentials
          ============================
          
          Keystore file: upload-keystore.jks
          Keystore alias: upload
          Keystore password: $KEYSTORE_PASSWORD
          Key password: $KEY_PASSWORD
          
          Upload Key SHA-256 Fingerprint:
          $FINGERPRINT
          
          IMPORTANT NOTES:
          ================
          1. Keep this keystore and passwords safe! You'll need them for future app updates.
          2. The SHA-256 fingerprint above is for the UPLOAD key.
          3. After enabling Play App Signing in Google Play Console, you must update
             the assetlinks.json file with the APP SIGNING key fingerprint (not this one).
          4. Get the App Signing key SHA-256 from Play Console > Setup > App signing
          5. Update: https://rickkent48-collab.github.io/.well-known/assetlinks.json
          EOF
          
          echo "Credentials file created"
      
      - name: Generate job summary
        env:
          FINGERPRINT: ${{ steps.fingerprint.outputs.fingerprint }}
        run: |
          set -euo pipefail
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… TWA App Bundle Build Complete
          
          ## Upload Key SHA-256 Fingerprint
          \`\`\`
          $FINGERPRINT
          \`\`\`
          
          ## ðŸ“¦ Artifacts
          The following artifacts have been uploaded:
          - **TheMemoryCalendar-release-signed.aab** - Signed Android App Bundle
          - **upload-keystore.jks** - Upload keystore (keep this safe!)
          - **keystore-credentials.txt** - Keystore credentials and passwords
          
          ## âš ï¸ Important Next Steps
          
          1. **Download all artifacts** from this workflow run
          2. **Keep the keystore and credentials safe** - you'll need them for future updates
          3. **Upload the .aab to Google Play Console** (Internal Testing track)
          4. **Enable Play App Signing** in Play Console
          5. **Get the App Signing key SHA-256** from Play Console > Setup > App signing
          6. **Update assetlinks.json** with the App Signing key (NOT the upload key shown above)
             - File location: \`https://rickkent48-collab.github.io/.well-known/assetlinks.json\`
             - Use the SHA-256 from Play Console App Signing, not the upload key
          
          ## ðŸ“± Testing
          After updating assetlinks.json:
          - Install the internal test build on your device
          - The app should open fullscreen without the URL bar
          - Verify the TWA is working correctly
          
          See [README-TWA-BUILD.md](.github/workflows/README-TWA-BUILD.md) for detailed instructions.
          EOF
      
      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-app-bundle
          path: TheMemoryCalendar-release-signed.aab
          retention-days: 90
      
      - name: Upload keystore
        uses: actions/upload-artifact@v4
        with:
          name: upload-keystore
          path: upload-keystore.jks
          retention-days: 90
      
      - name: Upload credentials
        uses: actions/upload-artifact@v4
        with:
          name: keystore-credentials
          path: keystore-credentials.txt
          retention-days: 90
