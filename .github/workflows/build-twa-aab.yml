name: Build Signed TWA App Bundle

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Android SDK
        run: |
          set -euo pipefail
          
          echo "::group::Setting up Android SDK"
          
          # Set ANDROID_SDK_ROOT
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # Create SDK directory
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT
          
          # Download and install commandline-tools
          echo "Downloading Android commandline-tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
          
          echo "Extracting commandline-tools..."
          unzip -q /tmp/cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          
          # Move to proper structure (cmdline-tools/latest)
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv /tmp/cmdline-tools-tmp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          
          echo "::endgroup::"
          
          echo "::group::Accepting Android SDK licenses"
          # Accept licenses - use yes with proper error handling
          yes 2>/dev/null | sdkmanager --licenses || echo "License acceptance process completed (exit code: $?)"
          echo "::endgroup::"
          
          echo "::group::Installing Android SDK components"
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          echo "::endgroup::"
          
          echo "::group::Verifying Android SDK installation"
          echo "âœ“ Android SDK setup complete"
          
          # Echo versions for diagnostics
          echo "SDK Manager version:"
          sdkmanager --version || echo "Note: sdkmanager version check failed, but this does not affect SDK functionality"
          
          # Verify installation
          echo ""
          echo "SDK components installed:"
          sdkmanager --list_installed
          echo "::endgroup::"
      
      - name: Generate upload keystore
        run: |
          set -euo pipefail
          
          echo "::group::Generating upload keystore"
          
          # Generate random passwords for keystore and key
          KEYSTORE_PASSWORD=$(openssl rand -base64 32)
          KEY_PASSWORD=$(openssl rand -base64 32)
          
          # Generate PKCS12 keystore with alias "upload"
          keytool -genkeypair \
            -alias upload \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore upload-keystore.jks \
            -storetype PKCS12 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -dname "CN=The Memory Calendar, OU=Development, O=rickkent48-collab, L=Unknown, ST=Unknown, C=US"
          
          echo "âœ“ Keystore generated: upload-keystore.jks"
          
          # Save credentials to file for artifact upload
          cat > keystore-credentials.txt << EOF
          Keystore: upload-keystore.jks
          Store Type: PKCS12
          Key Alias: upload
          Store Password: $KEYSTORE_PASSWORD
          Key Password: $KEY_PASSWORD
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          echo "âœ“ Credentials saved to keystore-credentials.txt"
          
          # Export environment variables for Gradle signing
          echo "SIGN_STORE_FILE=$PWD/upload-keystore.jks" >> $GITHUB_ENV
          echo "SIGN_STORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGN_KEY_ALIAS=upload" >> $GITHUB_ENV
          echo "SIGN_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
          
          echo "::endgroup::"
      
      - name: Verify keystore entry
        run: |
          set -euo pipefail
          
          echo "::group::Verifying keystore entry"
          
          # List keystore contents to verify entry type
          keytool -list -v \
            -keystore upload-keystore.jks \
            -storetype PKCS12 \
            -storepass "$SIGN_STORE_PASSWORD" \
            | grep -A 5 "Alias name: upload"
          
          # Verify it's a PrivateKeyEntry
          ENTRY_TYPE=$(keytool -list -v \
            -keystore upload-keystore.jks \
            -storetype PKCS12 \
            -storepass "$SIGN_STORE_PASSWORD" \
            | grep "Entry type:" | head -1 | awk '{print $3}')
          
          echo ""
          echo "Entry type: $ENTRY_TYPE"
          
          if [ "$ENTRY_TYPE" = "PrivateKeyEntry" ]; then
            echo "âœ“ Keystore entry verified as PrivateKeyEntry"
          else
            echo "âš  Warning: Entry type is $ENTRY_TYPE (expected PrivateKeyEntry)"
          fi
          
          echo "::endgroup::"
      
      - name: Build release app bundle
        working-directory: android-project
        run: |
          set -euo pipefail
          
          echo "::group::Building signed release app bundle"
          
          # Verify gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found in android-project/"
            echo "Contents of android-project:"
            ls -la
            exit 1
          fi
          
          # Build the release app bundle using Gradle with signing
          chmod +x gradlew
          ./gradlew --stacktrace --no-daemon bundleRelease
          
          echo "âœ“ Signed app bundle built successfully"
          echo "::endgroup::"
      
      - name: Copy signed AAB to repository root
        run: |
          set -euo pipefail
          
          AAB_PATH=$(find android-project/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "::error::Could not find AAB file in app/build/outputs/bundle/release"
            exit 1
          fi
          
          echo "Found signed AAB: $AAB_PATH"
          cp "$AAB_PATH" TheMemoryCalendar-release-signed.aab
          echo "Copied to: TheMemoryCalendar-release-signed.aab"
          ls -lh TheMemoryCalendar-release-signed.aab
      
      - name: Generate job summary
        run: |
          set -euo pipefail
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… TWA Signed App Bundle Build Complete
          
          ## ðŸ“¦ Artifacts
          The signed Android App Bundle and keystore have been uploaded:
          - **TheMemoryCalendar-release-signed.aab** - Signed bundle ready for Play Console
          - **upload-keystore.jks** - PKCS12 keystore used for signing
          - **keystore-credentials.txt** - Keystore passwords and details
          
          ## ðŸš€ Next Steps: Play App Signing Setup
          
          ### 1. Upload to Google Play Console
          - Download the artifact \`app-bundle-signed\` from this workflow run
          - Go to [Google Play Console](https://play.google.com/console)
          - Navigate to your app â†’ **Internal testing** track
          - Create a new release and upload \`TheMemoryCalendar-release-signed.aab\`
          
          ### 2. Enable Play App Signing
          - During the first upload, Google will prompt you to enable **Play App Signing**
          - Accept and let Google manage your app signing key
          - Google will re-sign your AAB with their managed key
          
          ### 3. Update assetlinks.json with App Signing Key
          After enabling Play App Signing:
          1. Go to **Play Console â†’ Setup â†’ App signing**
          2. Copy the **App signing key certificate SHA-256 fingerprint**
          3. Update the \`assetlinks.json\` file at:
             \`\`\`
             https://rickkent48-collab.github.io/.well-known/assetlinks.json
             \`\`\`
          4. Replace the SHA-256 fingerprint in the \`sha256_cert_fingerprints\` array with the one from Play Console
          
          ### 4. Verify TWA Integration
          - Install the app from Internal Testing on your device
          - The app should open fullscreen without the browser URL bar
          - If you see a URL bar, verify the assetlinks.json SHA-256 matches exactly
          
          ## ðŸ“š Additional Resources
          - [Play App Signing Documentation](https://support.google.com/googleplay/android-developer/answer/9842756)
          - [Trusted Web Activity Overview](https://developer.chrome.com/docs/android/trusted-web-activity/)
          
          ---
          
          **Build Info:**
          - Workflow: \`${{ github.workflow }}\`
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Run ID: \`${{ github.run_id }}\`
          - Signing: Gradle signingConfigs (PKCS12 keystore)
          EOF
      
      - name: Upload signed AAB and keystore
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle-signed
          path: |
            TheMemoryCalendar-release-signed.aab
            upload-keystore.jks
            keystore-credentials.txt
          retention-days: 90
