name: Build Unsigned TWA App Bundle

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Android SDK
        run: |
          set -euo pipefail
          
          echo "::group::Setting up Android SDK"
          
          # Set ANDROID_SDK_ROOT
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # Create SDK directory
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT
          
          # Download and install commandline-tools
          echo "Downloading Android commandline-tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
          
          echo "Extracting commandline-tools..."
          unzip -q /tmp/cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          
          # Move to proper structure (cmdline-tools/latest)
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv /tmp/cmdline-tools-tmp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          
          echo "::endgroup::"
          
          echo "::group::Accepting Android SDK licenses"
          # Accept licenses - use yes with proper error handling
          yes 2>/dev/null | sdkmanager --licenses || echo "License acceptance process completed (exit code: $?)"
          echo "::endgroup::"
          
          echo "::group::Installing Android SDK components"
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          echo "::endgroup::"
          
          echo "::group::Verifying Android SDK installation"
          echo "âœ“ Android SDK setup complete"
          
          # Echo versions for diagnostics
          echo "SDK Manager version:"
          sdkmanager --version || echo "Note: sdkmanager version check failed, but this does not affect SDK functionality"
          
          # Verify installation
          echo ""
          echo "SDK components installed:"
          sdkmanager --list_installed
          echo "::endgroup::"
      
      - name: Build release app bundle
        working-directory: android-project
        run: |
          set -euo pipefail
          
          echo "::group::Building release app bundle"
          
          # Verify gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found in android-project/"
            echo "Contents of android-project:"
            ls -la
            exit 1
          fi
          
          # Build the release app bundle using Gradle
          chmod +x gradlew
          ./gradlew --stacktrace --no-daemon bundleRelease
          
          echo "âœ“ App bundle built successfully"
          echo "::endgroup::"
      
      - name: Copy unsigned AAB to repository root
        run: |
          set -euo pipefail
          
          AAB_PATH=$(find android-project/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "::error::Could not find AAB file in app/build/outputs/bundle/release"
            exit 1
          fi
          
          echo "Found unsigned AAB: $AAB_PATH"
          cp "$AAB_PATH" TheMemoryCalendar-release-unsigned.aab
          echo "Copied to: TheMemoryCalendar-release-unsigned.aab"
          ls -lh TheMemoryCalendar-release-unsigned.aab
      
      - name: Generate job summary
        run: |
          set -euo pipefail
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… TWA Unsigned App Bundle Build Complete
          
          ## ðŸ“¦ Artifact
          The unsigned Android App Bundle has been uploaded:
          - **TheMemoryCalendar-release-unsigned.aab** - Unsigned bundle ready for Play Console
          
          ## ðŸš€ Next Steps: Play App Signing Setup
          
          ### 1. Upload to Google Play Console
          - Download the artifact \`app-bundle-unsigned\` from this workflow run
          - Go to [Google Play Console](https://play.google.com/console)
          - Navigate to your app â†’ **Internal testing** track
          - Create a new release and upload \`TheMemoryCalendar-release-unsigned.aab\`
          
          ### 2. Enable Play App Signing
          - During the first upload, Google will prompt you to enable **Play App Signing**
          - Accept and let Google manage your app signing key
          - Google will re-sign your AAB with their managed key
          
          ### 3. Update assetlinks.json with App Signing Key
          After enabling Play App Signing:
          1. Go to **Play Console â†’ Setup â†’ App signing**
          2. Copy the **App signing key certificate SHA-256 fingerprint**
          3. Update the \`assetlinks.json\` file at:
             \`\`\`
             https://rickkent48-collab.github.io/.well-known/assetlinks.json
             \`\`\`
          4. Replace the SHA-256 fingerprint in the \`sha256_cert_fingerprints\` array with the one from Play Console
          
          ### 4. Verify TWA Integration
          - Install the app from Internal Testing on your device
          - The app should open fullscreen without the browser URL bar
          - If you see a URL bar, verify the assetlinks.json SHA-256 matches exactly
          
          ## ðŸ“š Additional Resources
          - [Play App Signing Documentation](https://support.google.com/googleplay/android-developer/answer/9842756)
          - [Trusted Web Activity Overview](https://developer.chrome.com/docs/android/trusted-web-activity/)
          
          ---
          
          **Build Info:**
          - Workflow: \`${{ github.workflow }}\`
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Run ID: \`${{ github.run_id }}\`
          EOF
      
      - name: Upload unsigned AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle-unsigned
          path: TheMemoryCalendar-release-unsigned.aab
          retention-days: 90
