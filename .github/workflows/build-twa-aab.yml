name: Build Signed TWA App Bundle

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Set up Android SDK
        run: |
          set -euo pipefail
          
          echo "::group::Setting up Android SDK"
          
          # Set ANDROID_SDK_ROOT
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # Create SDK directory
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT
          
          # Download and install commandline-tools
          echo "Downloading Android commandline-tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
          
          echo "Extracting commandline-tools..."
          unzip -q /tmp/cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          
          # Move to proper structure (cmdline-tools/latest)
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv /tmp/cmdline-tools-tmp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          
          echo "::endgroup::"
          
          echo "::group::Accepting Android SDK licenses"
          # Accept licenses - use yes with proper error handling
          yes 2>/dev/null | sdkmanager --licenses || echo "License acceptance process completed (exit code: $?)"
          echo "::endgroup::"
          
          echo "::group::Installing Android SDK components"
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          echo "::endgroup::"
          
          echo "::group::Verifying Android SDK installation"
          echo "âœ“ Android SDK setup complete"
          
          # Echo versions for diagnostics
          echo "SDK Manager version:"
          sdkmanager --version || echo "Note: sdkmanager version check failed, but this does not affect SDK functionality"
          
          # Verify installation
          echo ""
          echo "SDK components installed:"
          sdkmanager --list_installed
          echo "::endgroup::"
      
      - name: Generate keystore passwords
        id: keystore-passwords
        run: |
          set -euo pipefail
          
          # Generate random passwords for keystore
          KEYSTORE_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          KEY_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          
          echo "keystore_password=$KEYSTORE_PASSWORD" >> $GITHUB_OUTPUT
          echo "key_password=$KEY_PASSWORD" >> $GITHUB_OUTPUT
          
          echo "Generated keystore passwords"
      
      - name: Generate upload keystore (PKCS12) and verify
        id: gen-keystore
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
        run: |
          set -euo pipefail
          keytool -genkeypair -v \
            -keystore upload-keystore.jks \
            -storetype PKCS12 \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias upload \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -dname "CN=The Memory Calendar, OU=Development, O=GitHub, L=Unknown, ST=Unknown, C=US"

          echo "::group::Verify keystore entry type"
          # Display first 120 lines of keystore info for diagnostics (avoids log overflow)
          keytool -list -v -keystore upload-keystore.jks -storepass "$KEYSTORE_PASSWORD" -alias upload | sed -n '1,120p' || true
          ENTRY_TYPE=$(keytool -list -v -keystore upload-keystore.jks -storepass "$KEYSTORE_PASSWORD" -alias upload | grep -i "Entry type" | awk -F: '{print $2}' | tr -d ' ')
          echo "Entry type: $ENTRY_TYPE"
          if [ "$ENTRY_TYPE" != "PrivateKeyEntry" ]; then
            echo "::error::Keystore alias 'upload' is not a PrivateKeyEntry (got '$ENTRY_TYPE'). Signing cannot proceed."
            exit 1
          fi
          echo "::endgroup::"
      
      - name: Build release app bundle
        working-directory: android-project
        run: |
          set -euo pipefail
          
          echo "::group::Building release app bundle"
          
          # Verify gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found in android-project/"
            echo "Contents of android-project:"
            ls -la
            exit 1
          fi
          
          # Build the release app bundle using Gradle
          chmod +x gradlew
          ./gradlew --stacktrace --no-daemon bundleRelease
          
          echo "âœ“ App bundle built successfully"
          echo "::endgroup::"
      
      - name: Sign the app bundle (PKCS12) and produce signed output
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
        run: |
          set -euo pipefail
          AAB_PATH=$(find android-project/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "::error::Could not find AAB file in app/build/outputs/bundle/release"
            exit 1
          fi
          echo "Unsigned AAB: $AAB_PATH"

          jarsigner -verbose \
            -keystore upload-keystore.jks \
            -storetype PKCS12 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -sigalg SHA256withRSA \
            -digestalg SHA-256 \
            -signedjar TheMemoryCalendar-release-signed.aab \
            "$AAB_PATH" \
            upload

          echo "Signed AAB: TheMemoryCalendar-release-signed.aab"
      
      - name: Get upload key SHA-256 fingerprint
        id: fingerprint
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
        run: |
          set -euo pipefail
          
          # Get the SHA-256 fingerprint of the upload key
          FINGERPRINT=$(keytool -list -v \
            -keystore upload-keystore.jks \
            -alias upload \
            -storepass "$KEYSTORE_PASSWORD" | \
            grep "SHA256:" | \
            sed 's/.*SHA256: //')
          
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT
          echo "Upload Key SHA-256 Fingerprint: $FINGERPRINT"
      
      - name: Create credentials file
        env:
          KEYSTORE_PASSWORD: ${{ steps.keystore-passwords.outputs.keystore_password }}
          KEY_PASSWORD: ${{ steps.keystore-passwords.outputs.key_password }}
          FINGERPRINT: ${{ steps.fingerprint.outputs.fingerprint }}
        run: |
          set -euo pipefail
          
          cat > keystore-credentials.txt << EOF
          Upload Keystore Credentials
          ============================
          
          Keystore file: upload-keystore.jks
          Keystore alias: upload
          Keystore password: $KEYSTORE_PASSWORD
          Key password: $KEY_PASSWORD
          
          Upload Key SHA-256 Fingerprint:
          $FINGERPRINT
          
          IMPORTANT NOTES:
          ================
          1. Keep this keystore and passwords safe! You'll need them for future app updates.
          2. The SHA-256 fingerprint above is for the UPLOAD key.
          3. After enabling Play App Signing in Google Play Console, you must update
             the assetlinks.json file with the APP SIGNING key fingerprint (not this one).
          4. Get the App Signing key SHA-256 from Play Console > Setup > App signing
          5. Update: https://rickkent48-collab.github.io/.well-known/assetlinks.json
          EOF
          
          echo "Credentials file created"
      
      - name: Generate job summary
        env:
          FINGERPRINT: ${{ steps.fingerprint.outputs.fingerprint }}
        run: |
          set -euo pipefail
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… TWA App Bundle Build Complete
          
          ## Upload Key SHA-256 Fingerprint
          \`\`\`
          $FINGERPRINT
          \`\`\`
          
          ## ðŸ“¦ Artifacts
          The following artifacts have been uploaded:
          - **TheMemoryCalendar-release-signed.aab** - Signed Android App Bundle
          - **upload-keystore.jks** - Upload keystore (keep this safe!)
          - **keystore-credentials.txt** - Keystore credentials and passwords
          
          ## âš ï¸ Important Next Steps
          
          1. **Download all artifacts** from this workflow run
          2. **Keep the keystore and credentials safe** - you'll need them for future updates
          3. **Upload the .aab to Google Play Console** (Internal Testing track)
          4. **Enable Play App Signing** in Play Console
          5. **Get the App Signing key SHA-256** from Play Console > Setup > App signing
          6. **Update assetlinks.json** with the App Signing key (NOT the upload key shown above)
             - File location: \`https://rickkent48-collab.github.io/.well-known/assetlinks.json\`
             - Use the SHA-256 from Play Console App Signing, not the upload key
          
          ## ðŸ“± Testing
          After updating assetlinks.json:
          - Install the internal test build on your device
          - The app should open fullscreen without the URL bar
          - Verify the TWA is working correctly
          
          See [README-TWA-BUILD.md](.github/workflows/README-TWA-BUILD.md) for detailed instructions.
          EOF
      
      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-app-bundle
          path: TheMemoryCalendar-release-signed.aab
          retention-days: 90
      
      - name: Upload keystore
        uses: actions/upload-artifact@v4
        with:
          name: upload-keystore
          path: upload-keystore.jks
          retention-days: 90
      
      - name: Upload credentials
        uses: actions/upload-artifact@v4
        with:
          name: keystore-credentials
          path: keystore-credentials.txt
          retention-days: 90
